<!doctype html>
<html lang="en">
    <head>
		
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="">
        <link rel="shortcut icon" href="/ericliu.png"/>
        <link rel="canonical" href="http://guolinn.com/">
        <link rel="alternate" type="application/rss+xml" title="Eric Liu" href="/atom.xml">
        <title>mozjpeg—性能和压缩比全面均衡的jpeg编码器 | EricLiu</title>
        <meta name="description" content="{{meta_description}}">

        <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/styles/crisp.css">
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

    </head>
    
		<body class="post-template">
	

        <header id="header">
            <a id="logo" href="/"><img src="/ericliu.png" alt="EricLiu" /></a>
            <h1><a href="/">Eric Liu</a></h1>
            <p></p>
            <div id="follow-icons">
                  <a href="/atom.xml"><i class="fa fa-rss-square fa-2x"></i></a>
  </div>
<h6><a type="text/html" href="/about.html">About</a></h6>

        </header>

        <main id="content">
        

<article class="post">
  March 25, 2019
  
    <span class="taglist">  &middot; 
    
    
      <a href='/tags/编解码/'>编解码</a> 
    
      <a href='/tags/清晰度/'>清晰度</a> 
    
      <a href='/tags/图片/'>图片</a> 
    
      <a href='/tags/DCT/'>DCT</a> 
    
      <a href='/tags/量化/'>量化</a> 
    
    </span>
  

  <h1 class="post-title">mozjpeg—性能和压缩比全面均衡的jpeg编码器</h1>
  <section class="post-content article-entry">
    <p>mozjpeg 源码在此 <a href="https://github.com/mozilla/mozjpeg" target="_blank" rel="noopener">https://github.com/mozilla/mozjpeg</a><br>主要特性有：</p>
<ul>
<li>兼容libjpeg，可以无缝将libjpeg替换成mozjpeg。</li>
<li>渐进式编码。</li>
<li>网格量化法，这个特性也是我最关心的特性，这个特性实现了最大化压缩质量。</li>
<li>自定义量化表。</li>
<li>完全兼容web浏览器。</li>
</ul>
<p><img src="/mozjpeg.png" alt=""></p>
<h1 id="mozjpeg"><a href="#mozjpeg" class="headerlink" title="mozjpeg"></a>mozjpeg</h1><!--Note-->
<h2 id="一级"><a href="#一级" class="headerlink" title="一级"></a>一级</h2><!--/Note-->
<h2 id="jpeg-finish-compress-主要的循环在这里面"><a href="#jpeg-finish-compress-主要的循环在这里面" class="headerlink" title="jpeg_finish_compress() 主要的循环在这里面"></a>jpeg_finish_compress() 主要的循环在这里面</h2><!--Note-->
<h5 id="jcapimin-c"><a href="#jcapimin-c" class="headerlink" title="jcapimin.c"></a>jcapimin.c</h5><p>line: 173</p>
<h4 id="主要的循环在这里"><a href="#主要的循环在这里" class="headerlink" title="主要的循环在这里"></a>主要的循环在这里</h4><p>while(is_last_pass) {<br>   prepare_for_pass() 控制本次循环的走向<br>}</p>
<!--/Note-->
<h3 id="核心函数prepare-for-pass"><a href="#核心函数prepare-for-pass" class="headerlink" title="核心函数prepare_for_pass()"></a>核心函数prepare_for_pass()</h3><!--Note-->
<h6 id="各个阶段的初始化都是在此完成的。"><a href="#各个阶段的初始化都是在此完成的。" class="headerlink" title="各个阶段的初始化都是在此完成的。"></a>各个阶段的初始化都是在此完成的。</h6><p>jcmaster.c line:460</p>
<p>例如：<br>case: main_pass</p>
<p>case:output_pass</p>
<p>case: trellis_pass   网格量化</p>
<p>case: huff_opt_pass<br><!--/Note--></p>
<h4 id="compress-data-compress-output"><a href="#compress-data-compress-output" class="headerlink" title="compress_data()  compress_output()"></a>compress_data()  compress_output()</h4><!--Note-->
<p>####### jccoefct.c  line:156 和 line:498</p>
<!--/Note-->
<h5 id="encode-mcu-AC-first"><a href="#encode-mcu-AC-first" class="headerlink" title="encode_mcu_AC_first"></a>encode_mcu_AC_first</h5><!--Note-->
<p>######## jcarith.c  line:460<br>编码核心<br>该步骤也是耗时最长，优化效果最好的部分</p>
<p>依据标准实现<br><a href="https://www.w3.org/Graphics/JPEG/itu-t81.pdf" target="_blank" rel="noopener">https://www.w3.org/Graphics/JPEG/itu-t81.pdf</a><br>主要是yong’lai算DCT的<br><!--/Note--></p>
<h6 id="arith-encode"><a href="#arith-encode" class="headerlink" title="arith_encode()"></a>arith_encode()</h6><!--Note-->
<p>######### jcarith.c line:225<br><!--/Note--></p>
<h5 id="compress-trellis-pass"><a href="#compress-trellis-pass" class="headerlink" title="compress_trellis_pass()"></a>compress_trellis_pass()</h5><p>jccoefct.c line: 353</p>
<p>改函数结束时，已经完成了DCT, 量化，网格量化的过程，因为最后调用了compress_output(), 把数据传递给了熵编码器处理了，即哈夫曼编码或者算数编码。</p>
<h6 id="quantize-trellis"><a href="#quantize-trellis" class="headerlink" title="quantize_trellis()"></a>quantize_trellis()</h6><p>jcdctmgr.c line: 930</p>
<h6 id="compress-output"><a href="#compress-output" class="headerlink" title="compress_output()"></a>compress_output()</h6><h5 id="encode-mcu-AC-refine"><a href="#encode-mcu-AC-refine" class="headerlink" title="encode_mcu_AC_refine"></a>encode_mcu_AC_refine</h5><h5 id="encode-mcu-DC-first"><a href="#encode-mcu-DC-first" class="headerlink" title="encode_mcu_DC_first"></a>encode_mcu_DC_first</h5><h5 id="access-virt-barray"><a href="#access-virt-barray" class="headerlink" title="access_virt_barray()"></a>access_virt_barray()</h5><!--Note-->
<p>######### jccoefct.c  line:515<br><!--/Note--></p>
<h4 id="access-virt-barray-1"><a href="#access-virt-barray-1" class="headerlink" title="access_virt_barray()"></a>access_virt_barray()</h4><!--Note-->
<p>######## jmemmgr.c line:906</p>
<p>To read the contents of a JPEG file as DCT coefficients, open the file and do<br>jpeg_read_header() as usual.  But instead of calling jpeg_start_decompress()<br>and jpeg_read_scanlines(), call jpeg_read_coefficients().  This will read the<br>entire image into a set of virtual coefficient-block arrays, one array per<br>component.  The return value is a pointer to an array of virtual-array<br>descriptors.  Each virtual array can be accessed directly using the JPEG<br>memory manager’s access_virt_barray method (see Memory management, below,<br>and also read structure.txt’s discussion of virtual array handling).  Or,<br>for simple transcoding to a different JPEG file format, the array list can<br>just be handed directly to jpeg_write_coefficients().<br><!--/Note--></p>
<h2 id="jpeg-start-compress"><a href="#jpeg-start-compress" class="headerlink" title="jpeg_start_compress()"></a>jpeg_start_compress()</h2><!--Note-->
<h3 id="jcapistd-c-line-40"><a href="#jcapistd-c-line-40" class="headerlink" title="jcapistd.c   line:40"></a>jcapistd.c   line:40</h3><!--/Note-->
<h3 id="compress-first-pass"><a href="#compress-first-pass" class="headerlink" title="compress_first_pass()"></a>compress_first_pass()</h3><!--Note-->
<h6 id="jccoefct-c-line-260"><a href="#jccoefct-c-line-260" class="headerlink" title="jccoefct.c line:260"></a>jccoefct.c line:260</h6><!--/Note-->
<h4 id="4次循环forward-DCT"><a href="#4次循环forward-DCT" class="headerlink" title="4次循环forward_DCT()"></a>4次循环forward_DCT()</h4><h5 id="forward-DCT"><a href="#forward-DCT" class="headerlink" title="forward_DCT()"></a>forward_DCT()</h5><!--Note-->
<p>######## jcdctmgr.c  line:685<br><!--/Note--></p>
<h6 id="quantize"><a href="#quantize" class="headerlink" title="quantize()"></a>quantize()</h6><p>jcdctmgr.c line: 51</p>
<p>在forward_DCT()里<br>先做forward DCT，再算出来量化系数</p>
<p>####### coef_blocks</p>
<h4 id="do-quantize-coef-blocks-bi-divisors-workspace"><a href="#do-quantize-coef-blocks-bi-divisors-workspace" class="headerlink" title="(*do_quantize) (coef_blocks[bi], divisors, workspace)"></a>(*do_quantize) (coef_blocks[bi], divisors, workspace)</h4><p>大概就是: coef_blocks = workspace/divisors<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/* Quantize/descale the coefficients, and store into coef_blocks[] *</span><br></pre></td></tr></table></figure></p>
<p>jcdctmgr.c  line:750</p>
<p>量化系数存储在coef_blocks   line:676<br>/*</p>
<ul>
<li>Perform forward DCT on one or more blocks of a component.<br>*</li>
<li>The input samples are taken from the sample_data[] array starting at</li>
<li>position start_row/start_col, and moving to the right for any additional</li>
<li>blocks. The quantized coefficients are returned in coef_blocks[].<br>*/</li>
</ul>
<p>######## divisors</p>
<!--Note-->
<p>############ start_pass_fdctmgr()<br>jcdctmgr.c line : 245 </p>
<p>赋值给divisors<br><!--/Note--></p>
<p>######## workspace</p>
<!--Note-->
<p>############  (*do_preprocess) (workspace, qtbl)</p>
<p>是通过量化表计算出来的。<br><!--/Note--></p>
<h4 id="compress-output-1"><a href="#compress-output-1" class="headerlink" title="compress_output()"></a>compress_output()</h4><!--Note-->
<p>####### jccoefct.c line:499</p>
<!--/Note-->
<p>我们来重点看下网格量化是怎么回事。<br>quantize_trellis()代码位于jcdctmgr.c文件内</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br></pre></td><td class="code"><pre><span class="line">GLOBAL(<span class="keyword">void</span>)</span><br><span class="line">quantize_trellis(j_compress_ptr cinfo, </span><br><span class="line">                 c_derived_tbl *dctbl,   DC哈夫曼编码相关table</span><br><span class="line">                 c_derived_tbl *actbl,   AC哈夫曼编码相关table</span><br><span class="line">                 JBLOCKROW coef_blocks,   <span class="comment">//thisblockrow   forward_DCT和量化后产生的系数矩阵</span></span><br><span class="line">                 JBLOCKROW src, </span><br><span class="line">                 JDIMENSION num_blocks,</span><br><span class="line">                 JQUANT_TBL * qtbl, </span><br><span class="line">                 <span class="keyword">double</span> *norm_src,     <span class="comment">// 已打印 </span></span><br><span class="line">                 <span class="keyword">double</span> *norm_coef,    <span class="comment">// 已打印</span></span><br><span class="line">                 JCOEF *last_dc_val,</span><br><span class="line">                 JBLOCKROW coef_blocks_above, </span><br><span class="line">                 JBLOCKROW src_above</span><br><span class="line">                 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> i, j, k, l;</span><br><span class="line">  <span class="keyword">float</span> accumulated_zero_dist[DCTSIZE2];</span><br><span class="line">  <span class="keyword">float</span> accumulated_cost[DCTSIZE2];</span><br><span class="line">  <span class="keyword">int</span> run_start[DCTSIZE2];</span><br><span class="line">  <span class="keyword">int</span> bi;</span><br><span class="line">  <span class="keyword">float</span> best_cost;</span><br><span class="line">  <span class="keyword">int</span> last_coeff_idx; <span class="comment">/* position of last nonzero coefficient */</span></span><br><span class="line">  <span class="keyword">float</span> norm = <span class="number">0.0</span>;</span><br><span class="line">  <span class="keyword">float</span> lambda_base;</span><br><span class="line">  <span class="keyword">float</span> lambda;</span><br><span class="line">  <span class="keyword">float</span> lambda_dc;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">float</span> *lambda_tbl = (cinfo-&gt;master-&gt;use_lambda_weight_tbl) ?</span><br><span class="line">                            jpeg_lambda_weights_csf_luma :</span><br><span class="line">                            jpeg_lambda_weights_flat;</span><br><span class="line">  <span class="keyword">int</span> Ss, Se;</span><br><span class="line">  <span class="keyword">float</span> *accumulated_zero_block_cost = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">float</span> *accumulated_block_cost = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">int</span> *block_run_start = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">int</span> *requires_eob = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">int</span> has_eob;</span><br><span class="line">  <span class="keyword">float</span> cost_all_zeros;</span><br><span class="line">  <span class="keyword">float</span> best_cost_skip;</span><br><span class="line">  <span class="keyword">float</span> cost;</span><br><span class="line">  <span class="keyword">int</span> zero_run;</span><br><span class="line">  <span class="keyword">int</span> run_bits;</span><br><span class="line">  <span class="keyword">int</span> rate;</span><br><span class="line">  <span class="keyword">float</span> *accumulated_dc_cost[DC_TRELLIS_MAX_CANDIDATES];</span><br><span class="line">  <span class="keyword">int</span> *dc_cost_backtrack[DC_TRELLIS_MAX_CANDIDATES];</span><br><span class="line">  JCOEF *dc_candidate[DC_TRELLIS_MAX_CANDIDATES];</span><br><span class="line">  <span class="keyword">int</span> mode = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">float</span> lambda_table[DCTSIZE2];</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> dc_trellis_candidates = get_num_dc_trellis_candidates(qtbl-&gt;quantval[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  Ss = cinfo-&gt;Ss;</span><br><span class="line">  Se = cinfo-&gt;Se;</span><br><span class="line">  <span class="keyword">if</span> (Ss == <span class="number">0</span>)</span><br><span class="line">    Ss = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (Se &lt; Ss)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (cinfo-&gt;master-&gt;trellis_eob_opt) &#123;</span><br><span class="line">    accumulated_zero_block_cost = (<span class="keyword">float</span> *)<span class="built_in">malloc</span>((num_blocks + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span><br><span class="line">    accumulated_block_cost = (<span class="keyword">float</span> *)<span class="built_in">malloc</span>((num_blocks + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span><br><span class="line">    block_run_start = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(num_blocks * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    requires_eob = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>((num_blocks + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (!accumulated_zero_block_cost ||</span><br><span class="line">        !accumulated_block_cost ||</span><br><span class="line">        !block_run_start ||</span><br><span class="line">        !requires_eob) &#123;</span><br><span class="line">      ERREXIT(cinfo, JERR_OUT_OF_MEMORY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    accumulated_zero_block_cost[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    accumulated_block_cost[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    requires_eob[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cinfo-&gt;master-&gt;trellis_quant_dc) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dc_trellis_candidates; i++) &#123;</span><br><span class="line">      accumulated_dc_cost[i] = (<span class="keyword">float</span> *)<span class="built_in">malloc</span>(num_blocks * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span><br><span class="line">      dc_cost_backtrack[i] = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(num_blocks * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">      dc_candidate[i] = (JCOEF *)<span class="built_in">malloc</span>(num_blocks * <span class="keyword">sizeof</span>(JCOEF));</span><br><span class="line">      <span class="keyword">if</span> (!accumulated_dc_cost[i] ||</span><br><span class="line">          !dc_cost_backtrack[i] ||</span><br><span class="line">          !dc_candidate[i]) &#123;</span><br><span class="line">        ERREXIT(cinfo, JERR_OUT_OF_MEMORY);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  norm = <span class="number">0.0</span>;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; DCTSIZE2; i++) &#123;</span><br><span class="line">    norm += qtbl-&gt;quantval[i] * qtbl-&gt;quantval[i];</span><br><span class="line">  &#125;</span><br><span class="line">  norm /= <span class="number">63.0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mode == <span class="number">1</span>) &#123;</span><br><span class="line">    lambda_base = <span class="number">1.0</span>;</span><br><span class="line">    lambda_tbl = lambda_table;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; DCTSIZE2; i++)</span><br><span class="line">      lambda_table[i] = <span class="number">1.0</span> / (qtbl-&gt;quantval[i] * qtbl-&gt;quantval[i]);</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">    lambda_base = <span class="number">1.0</span> / norm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (bi = <span class="number">0</span>; bi &lt; num_blocks; bi++) &#123;</span><br><span class="line">    </span><br><span class="line">    norm = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; DCTSIZE2; i++) &#123;</span><br><span class="line">      norm += src[bi][i] * src[bi][i];</span><br><span class="line">    &#125;</span><br><span class="line">    norm /= <span class="number">63.0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cinfo-&gt;master-&gt;lambda_log_scale2 &gt; <span class="number">0.0</span>)</span><br><span class="line">      lambda = <span class="built_in">pow</span>(<span class="number">2.0</span>, cinfo-&gt;master-&gt;lambda_log_scale1) * lambda_base /</span><br><span class="line">                   (<span class="built_in">pow</span>(<span class="number">2.0</span>, cinfo-&gt;master-&gt;lambda_log_scale2) + norm);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      lambda = <span class="built_in">pow</span>(<span class="number">2.0</span>, cinfo-&gt;master-&gt;lambda_log_scale1 - <span class="number">12.0</span>) * lambda_base;</span><br><span class="line">    </span><br><span class="line">    lambda_dc = lambda * lambda_tbl[<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    accumulated_zero_dist[Ss<span class="number">-1</span>] = <span class="number">0.0</span>;</span><br><span class="line">    accumulated_cost[Ss<span class="number">-1</span>] = <span class="number">0.0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Do DC coefficient */</span></span><br><span class="line">    <span class="keyword">if</span> (cinfo-&gt;master-&gt;trellis_quant_dc) &#123;</span><br><span class="line">      <span class="keyword">int</span> sign = src[bi][<span class="number">0</span>] &gt;&gt; <span class="number">31</span>;</span><br><span class="line">      <span class="keyword">int</span> x = <span class="built_in">abs</span>(src[bi][<span class="number">0</span>]);</span><br><span class="line">      <span class="keyword">int</span> q = <span class="number">8</span> * qtbl-&gt;quantval[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">int</span> qval;</span><br><span class="line">      <span class="keyword">float</span> dc_candidate_dist;</span><br><span class="line">    </span><br><span class="line">      qval = (x + q/<span class="number">2</span>) / q; <span class="comment">/* quantized value (round nearest) */</span></span><br><span class="line">      <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; dc_trellis_candidates; k++) &#123;</span><br><span class="line">        <span class="keyword">int</span> delta;</span><br><span class="line">        <span class="keyword">int</span> dc_delta;</span><br><span class="line">        <span class="keyword">int</span> bits;</span><br><span class="line">    </span><br><span class="line">        dc_candidate[k][bi] = qval - dc_trellis_candidates/<span class="number">2</span> + k;</span><br><span class="line">        <span class="keyword">if</span> (dc_candidate[k][bi] &gt;= (<span class="number">1</span>&lt;&lt;MAX_COEF_BITS))</span><br><span class="line">          dc_candidate[k][bi] = (<span class="number">1</span>&lt;&lt;MAX_COEF_BITS)<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (dc_candidate[k][bi] &lt;= -(<span class="number">1</span>&lt;&lt;MAX_COEF_BITS))</span><br><span class="line">          dc_candidate[k][bi] = -(<span class="number">1</span>&lt;&lt;MAX_COEF_BITS)+<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">        delta = dc_candidate[k][bi] * q - x;</span><br><span class="line">        dc_candidate_dist = delta * delta * lambda_dc;</span><br><span class="line">        dc_candidate[k][bi] *= <span class="number">1</span> + <span class="number">2</span>*sign;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Take into account DC differences */</span></span><br><span class="line">        <span class="keyword">if</span> (coef_blocks_above &amp;&amp; src_above &amp;&amp; cinfo-&gt;master-&gt;trellis_delta_dc_weight &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">          <span class="keyword">int</span> dc_above_orig;</span><br><span class="line">          <span class="keyword">int</span> dc_above_recon;</span><br><span class="line">          <span class="keyword">int</span> dc_orig;</span><br><span class="line">          <span class="keyword">int</span> dc_recon;</span><br><span class="line">          <span class="keyword">float</span> vertical_dist;</span><br><span class="line">          </span><br><span class="line">          dc_above_orig = src_above[bi][<span class="number">0</span>];</span><br><span class="line">          dc_above_recon = coef_blocks_above[bi][<span class="number">0</span>] * q;</span><br><span class="line">          dc_orig = src[bi][<span class="number">0</span>];</span><br><span class="line">          dc_recon = dc_candidate[k][bi] * q;</span><br><span class="line">          <span class="comment">/* delta is difference of vertical gradients */</span></span><br><span class="line">          delta = (dc_above_orig - dc_orig) - (dc_above_recon - dc_recon);</span><br><span class="line">          vertical_dist = delta * delta * lambda_dc;</span><br><span class="line">          dc_candidate_dist +=  cinfo-&gt;master-&gt;trellis_delta_dc_weight * (vertical_dist - dc_candidate_dist);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (bi == <span class="number">0</span>) &#123;</span><br><span class="line">          dc_delta = dc_candidate[k][bi] - *last_dc_val;</span><br><span class="line">    </span><br><span class="line">          <span class="comment">/* Derive number of suffix bits */</span></span><br><span class="line">          bits = <span class="number">0</span>;</span><br><span class="line">          dc_delta = <span class="built_in">abs</span>(dc_delta);</span><br><span class="line">          <span class="keyword">while</span> (dc_delta) &#123;</span><br><span class="line">            dc_delta &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">            bits++;</span><br><span class="line">          &#125;</span><br><span class="line">          cost = bits + dctbl-&gt;ehufsi[bits] + dc_candidate_dist;</span><br><span class="line">          accumulated_dc_cost[k][<span class="number">0</span>] = cost;</span><br><span class="line">          dc_cost_backtrack[k][<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">for</span> (l = <span class="number">0</span>; l &lt; dc_trellis_candidates; l++) &#123;</span><br><span class="line">            dc_delta = dc_candidate[k][bi] - dc_candidate[l][bi<span class="number">-1</span>];</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/* Derive number of suffix bits */</span></span><br><span class="line">            bits = <span class="number">0</span>;</span><br><span class="line">            dc_delta = <span class="built_in">abs</span>(dc_delta);</span><br><span class="line">            <span class="keyword">while</span> (dc_delta) &#123;</span><br><span class="line">              dc_delta &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">              bits++;</span><br><span class="line">            &#125;</span><br><span class="line">            cost = bits + dctbl-&gt;ehufsi[bits] + dc_candidate_dist + accumulated_dc_cost[l][bi<span class="number">-1</span>];</span><br><span class="line">            <span class="keyword">if</span> (l == <span class="number">0</span> || cost &lt; accumulated_dc_cost[k][bi]) &#123;</span><br><span class="line">              accumulated_dc_cost[k][bi] = cost;</span><br><span class="line">              dc_cost_backtrack[k][bi] = l;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Do AC coefficients */</span></span><br><span class="line">    <span class="keyword">for</span> (i = Ss; i &lt;= Se; i++) &#123;</span><br><span class="line">      <span class="keyword">int</span> z = jpeg_natural_order[i];</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">int</span> sign = src[bi][z] &gt;&gt; <span class="number">31</span>;</span><br><span class="line">      <span class="keyword">int</span> x = <span class="built_in">abs</span>(src[bi][z]);</span><br><span class="line">      <span class="keyword">int</span> q = <span class="number">8</span> * qtbl-&gt;quantval[z];</span><br><span class="line">      <span class="keyword">int</span> candidate[<span class="number">16</span>];</span><br><span class="line">      <span class="keyword">int</span> candidate_bits[<span class="number">16</span>];</span><br><span class="line">      <span class="keyword">float</span> candidate_dist[<span class="number">16</span>];</span><br><span class="line">      <span class="keyword">int</span> num_candidates;</span><br><span class="line">      <span class="keyword">int</span> qval;</span><br><span class="line">      </span><br><span class="line">      accumulated_zero_dist[i] = x * x * lambda * lambda_tbl[z] + accumulated_zero_dist[i<span class="number">-1</span>];</span><br><span class="line">      </span><br><span class="line">      qval = (x + q/<span class="number">2</span>) / q; <span class="comment">/* quantized value (round nearest) */</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> (qval == <span class="number">0</span>) &#123;</span><br><span class="line">        coef_blocks[bi][z] = <span class="number">0</span>;</span><br><span class="line">        accumulated_cost[i] = <span class="number">1e38</span>; <span class="comment">/* Shouldn't be needed */</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> (qval &gt;= (<span class="number">1</span>&lt;&lt;MAX_COEF_BITS))</span><br><span class="line">        qval = (<span class="number">1</span>&lt;&lt;MAX_COEF_BITS)<span class="number">-1</span>;</span><br><span class="line">      </span><br><span class="line">      num_candidates = jpeg_nbits_table[qval];</span><br><span class="line">      <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; num_candidates; k++) &#123;</span><br><span class="line">        <span class="keyword">int</span> delta;</span><br><span class="line">        candidate[k] = (k &lt; num_candidates - <span class="number">1</span>) ? (<span class="number">2</span> &lt;&lt; k) - <span class="number">1</span> : qval;</span><br><span class="line">        delta = candidate[k] * q - x;</span><br><span class="line">        candidate_bits[k] = k+<span class="number">1</span>;</span><br><span class="line">        candidate_dist[k] = delta * delta * lambda * lambda_tbl[z];</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      accumulated_cost[i] = <span class="number">1e38</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (j = Ss<span class="number">-1</span>; j &lt; i; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> zz = jpeg_natural_order[j];</span><br><span class="line">        <span class="keyword">if</span> (j != Ss<span class="number">-1</span> &amp;&amp; coef_blocks[bi][zz] == <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        zero_run = i - <span class="number">1</span> - j;</span><br><span class="line">        <span class="keyword">if</span> ((zero_run &gt;&gt; <span class="number">4</span>) &amp;&amp; actbl-&gt;ehufsi[<span class="number">0xf0</span>] == <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        run_bits = (zero_run &gt;&gt; <span class="number">4</span>) * actbl-&gt;ehufsi[<span class="number">0xf0</span>];</span><br><span class="line">        zero_run &amp;= <span class="number">15</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; num_candidates; k++) &#123;</span><br><span class="line">          <span class="keyword">int</span> coef_bits = actbl-&gt;ehufsi[<span class="number">16</span> * zero_run + candidate_bits[k]];</span><br><span class="line">          <span class="keyword">if</span> (coef_bits == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          </span><br><span class="line">          rate = coef_bits + candidate_bits[k] + run_bits;</span><br><span class="line">          cost = rate + candidate_dist[k];</span><br><span class="line">          cost += accumulated_zero_dist[i<span class="number">-1</span>] - accumulated_zero_dist[j] + accumulated_cost[j];</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (cost &lt; accumulated_cost[i]) &#123;</span><br><span class="line">            coef_blocks[bi][z] = (candidate[k] ^ sign) - sign;</span><br><span class="line">            accumulated_cost[i] = cost;</span><br><span class="line">            run_start[i] = j;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    last_coeff_idx = Ss<span class="number">-1</span>;</span><br><span class="line">    best_cost = accumulated_zero_dist[Se] + actbl-&gt;ehufsi[<span class="number">0</span>];</span><br><span class="line">    cost_all_zeros = accumulated_zero_dist[Se];</span><br><span class="line">    best_cost_skip = cost_all_zeros;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = Ss; i &lt;= Se; i++) &#123;</span><br><span class="line">      <span class="keyword">int</span> z = jpeg_natural_order[i];</span><br><span class="line">      <span class="keyword">if</span> (coef_blocks[bi][z] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> cost = accumulated_cost[i] + accumulated_zero_dist[Se] - accumulated_zero_dist[i];</span><br><span class="line">        <span class="keyword">float</span> cost_wo_eob = cost;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (i &lt; Se)</span><br><span class="line">          cost += actbl-&gt;ehufsi[<span class="number">0</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cost &lt; best_cost) &#123;</span><br><span class="line">          best_cost = cost;</span><br><span class="line">          last_coeff_idx = i;</span><br><span class="line">          best_cost_skip = cost_wo_eob;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    has_eob = (last_coeff_idx &lt; Se) + (last_coeff_idx == Ss<span class="number">-1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Zero out coefficients that are part of runs */</span></span><br><span class="line">    i = Se;</span><br><span class="line">    <span class="keyword">while</span> (i &gt;= Ss)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> (i &gt; last_coeff_idx) &#123;</span><br><span class="line">        <span class="keyword">int</span> z = jpeg_natural_order[i];</span><br><span class="line">        coef_blocks[bi][z] = <span class="number">0</span>;</span><br><span class="line">        i--;</span><br><span class="line">      &#125;</span><br><span class="line">      last_coeff_idx = run_start[i];</span><br><span class="line">      i--;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cinfo-&gt;master-&gt;trellis_eob_opt) &#123;</span><br><span class="line">      accumulated_zero_block_cost[bi+<span class="number">1</span>] = accumulated_zero_block_cost[bi];</span><br><span class="line">      accumulated_zero_block_cost[bi+<span class="number">1</span>] += cost_all_zeros;</span><br><span class="line">      requires_eob[bi+<span class="number">1</span>] = has_eob;</span><br><span class="line">      </span><br><span class="line">      best_cost = <span class="number">1e38</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (has_eob != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= bi; i++) &#123;</span><br><span class="line">          <span class="keyword">int</span> zero_block_run;</span><br><span class="line">          <span class="keyword">int</span> nbits;</span><br><span class="line">          <span class="keyword">float</span> cost;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (requires_eob[i] == <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          </span><br><span class="line">          cost = best_cost_skip; <span class="comment">/* cost of coding a nonzero block */</span></span><br><span class="line">          cost += accumulated_zero_block_cost[bi];</span><br><span class="line">          cost -= accumulated_zero_block_cost[i];</span><br><span class="line">          cost += accumulated_block_cost[i];</span><br><span class="line">          zero_block_run = bi - i + requires_eob[i];</span><br><span class="line">          nbits = jpeg_nbits_table[zero_block_run];</span><br><span class="line">          cost += actbl-&gt;ehufsi[<span class="number">16</span>*nbits] + nbits;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (cost &lt; best_cost) &#123;</span><br><span class="line">            block_run_start[bi] = i;</span><br><span class="line">            best_cost = cost;</span><br><span class="line">            accumulated_block_cost[bi+<span class="number">1</span>] = cost;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cinfo-&gt;master-&gt;trellis_eob_opt) &#123;</span><br><span class="line">    <span class="keyword">int</span> last_block = num_blocks;</span><br><span class="line">    best_cost = <span class="number">1e38</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= num_blocks; i++) &#123;</span><br><span class="line">      <span class="keyword">int</span> zero_block_run;</span><br><span class="line">      <span class="keyword">int</span> nbits;</span><br><span class="line">      <span class="keyword">float</span> cost = <span class="number">0.0</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (requires_eob[i] == <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    </span><br><span class="line">      cost += accumulated_zero_block_cost[num_blocks];</span><br><span class="line">      cost -= accumulated_zero_block_cost[i];</span><br><span class="line">      zero_block_run = num_blocks - i + requires_eob[i];</span><br><span class="line">      nbits = jpeg_nbits_table[zero_block_run];</span><br><span class="line">      cost += actbl-&gt;ehufsi[<span class="number">16</span>*nbits] + nbits;</span><br><span class="line">      <span class="keyword">if</span> (cost &lt; best_cost) &#123;</span><br><span class="line">        best_cost = cost;</span><br><span class="line">        last_block = i;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    last_block--;</span><br><span class="line">    bi = num_blocks - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (bi &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">while</span> (bi &gt; last_block) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = Ss; j &lt;= Se; j++) &#123;</span><br><span class="line">          <span class="keyword">int</span> z = jpeg_natural_order[j];</span><br><span class="line">          coef_blocks[bi][z] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bi--;</span><br><span class="line">      &#125;</span><br><span class="line">      last_block = block_run_start[bi]<span class="number">-1</span>;</span><br><span class="line">      bi--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(accumulated_zero_block_cost);</span><br><span class="line">    <span class="built_in">free</span>(accumulated_block_cost);</span><br><span class="line">    <span class="built_in">free</span>(block_run_start);</span><br><span class="line">    <span class="built_in">free</span>(requires_eob);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cinfo-&gt;master-&gt;trellis_q_opt) &#123;</span><br><span class="line">    <span class="keyword">for</span> (bi = <span class="number">0</span>; bi &lt; num_blocks; bi++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; DCTSIZE2; i++) &#123;</span><br><span class="line">        norm_src[i] += src[bi][i] * coef_blocks[bi][i];</span><br><span class="line">        norm_coef[i] += <span class="number">8</span> * coef_blocks[bi][i] * coef_blocks[bi][i];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cinfo-&gt;master-&gt;trellis_quant_dc) &#123;</span><br><span class="line">    j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; dc_trellis_candidates; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (accumulated_dc_cost[i][num_blocks<span class="number">-1</span>] &lt; accumulated_dc_cost[j][num_blocks<span class="number">-1</span>])</span><br><span class="line">        j = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (bi = num_blocks<span class="number">-1</span>; bi &gt;= <span class="number">0</span>; bi--) &#123;</span><br><span class="line">      coef_blocks[bi][<span class="number">0</span>] = dc_candidate[j][bi];</span><br><span class="line">      j = dc_cost_backtrack[j][bi];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Save DC predictor */</span></span><br><span class="line">    *last_dc_val = coef_blocks[num_blocks<span class="number">-1</span>][<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dc_trellis_candidates; i++) &#123;</span><br><span class="line">      <span class="built_in">free</span>(accumulated_dc_cost[i]);</span><br><span class="line">      <span class="built_in">free</span>(dc_cost_backtrack[i]);</span><br><span class="line">      <span class="built_in">free</span>(dc_candidate[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
  </section>
  <footer class="post-footer">
    <!--
    <section class="author">
      <h4>Eric Liu</h4>
      <p></p>
    </section>
    -->
  </footer>
</article>

<nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2019/03/27/trellis_quantize/">
        ← prev <!--网格量化-trellis quantize-->
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2019/03/12/guetzli-cuda/">
        <!--利用cuda和opencl来加速guetzli--> next →
    </a>
    
</nav>
<div id="comments">
<!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" data-uid="MTAyMC8zODI4NS8xNDgxMw==">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->
</div>


        </main>
        <footer id="footer">
            <section id="footer-message">&copy; 2019 Eric Liu. All rights reserved. Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. <a href="https://github.com/guolin/crisp-hexo-theme" target="_blank">crisp</a> </section>
        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1274257392'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s13.cnzz.com/z_stat.php%3Fid%3D1274257392%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script>
        </footer>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','/js/ga.js','ga');
            ga('create', 'UA-122301641-1', 'auto');
            ga('send', 'pageview');
        </script>

        <{% if (theme.mermaid.enable)  %}>
          <script src='https://cdn.bootcss.com/mermaid/7.1.2/mermaid.min.js'></script>
          <script>
            if (window.mermaid) {
              mermaid.initialize({theme: 'forest'});
            }
          </script>
        <{% endif %}>


    </body>
</html>


